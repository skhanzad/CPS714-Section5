import Item from '../models/Item.js';

export const createItem = async (req, res) => {
  try { const item = await Item.create(req.body); return res.status(201).json(item); }
  catch (e) { return res.status(400).json({ error: e.message }); }
};
export const listItems = async (req, res) => {
  const { q, status, skip = 0, limit = 25 } = req.query;
  const filter = {};
  if (status) filter.status = status;
  if (q) filter.$or = [{ title: { $regex: q, $options:'i' } }, { author: { $regex: q, $options:'i' } }];
  const items = await Item.find(filter).skip(Number(skip)).limit(Number(limit)).sort({ createdAt: -1 });
  return res.json(items);
};
export const getItem = async (req, res) => {
  const item = await Item.findById(req.params.id);
  if (!item) return res.status(404).json({ error: 'Item not found' });
  return res.json(item);
};
export const updateItem = async (req, res) => {
  const item = await Item.findByIdAndUpdate(req.params.id, req.body, { new: true });
  if (!item) return res.status(404).json({ error: 'Item not found' });
  return res.json(item);
};
export const deleteItem = async (req, res) => {
  const item = await Item.findByIdAndDelete(req.params.id);
  if (!item) return res.status(404).json({ error: 'Item not found' });
  return res.status(204).send();
};
export const assignRFID = async (req, res) => {
  const { rfid } = req.body;
  const item = await Item.findByIdAndUpdate(req.params.id, { rfid }, { new: true });
  if (!item) return res.status(404).json({ error: 'Item not found' });
  return res.json(item);
};
export const checkout = async (req, res) => {
  const { item_id, member_id } = req.body;
  const item = await Item.findById(item_id);
  if (!item) return res.status(404).json({ error: 'Item not found' });
  if (item.status !== 'AVAILABLE') return res.status(409).json({ error: 'Item not available for checkout' });
  item.status = 'CHECKED_OUT'; await item.save(); return res.json(item);
};
export const checkin = async (req, res) => {
  const { item_id } = req.body;
  const item = await Item.findById(item_id);
  if (!item) return res.status(404).json({ error: 'Item not found' });
  item.status = 'AVAILABLE'; await item.save(); return res.json(item);
};